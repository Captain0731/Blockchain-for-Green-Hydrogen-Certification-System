{% extends "base.html" %}

{% block title %}Blockchain Explorer - Green Hydrogen Platform{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-cubes me-2"></i>Blockchain Explorer</h2>
            <p class="text-muted">Explore the green hydrogen certification blockchain in 3D</p>
        </div>
    </div>
    
    <!-- Blockchain Stats -->
    <div class="row mb-4 g-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon bg-primary">
                    <i class="fas fa-cubes"></i>
                </div>
                <div class="stats-content">
                    <h3 id="total-blocks">Loading...</h3>
                    <p>Total Blocks</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon bg-success">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stats-content">
                    <h3 id="total-transactions">Loading...</h3>
                    <p>Transactions</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon bg-info">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stats-content">
                    <h3 id="chain-length">Loading...</h3>
                    <p>Chain Length</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon bg-warning">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="stats-content">
                    <h3>Verified</h3>
                    <p>Chain Status</p>
                    <div class="status-indicator active"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3D Blockchain Visualization -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="blockchain-explorer-card">
                <div class="explorer-header">
                    <h4><i class="fas fa-cube me-2"></i>3D Blockchain Visualization</h4>
                    <div class="explorer-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="resetCamera()">
                            <i class="fas fa-home"></i> Reset View
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="animateChain()">
                            <i class="fas fa-play"></i> Animate
                        </button>
                    </div>
                </div>
                <div class="explorer-body">
                    <div id="blockchain-3d" class="blockchain-3d-container"></div>
                    <div class="explorer-info">
                        <div class="info-panel" id="block-info">
                            <h6>Click a block to view details</h6>
                            <p class="text-muted">Select any block in the 3D visualization above to see its information.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Block Details Table -->
    <div class="row">
        <div class="col-12">
            <div class="content-card">
                <div class="content-header">
                    <h4><i class="fas fa-table me-2"></i>Block Details</h4>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshBlockchain()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
                <div class="content-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="blocks-table">
                            <thead>
                                <tr>
                                    <th>Index</th>
                                    <th>Hash</th>
                                    <th>Previous Hash</th>
                                    <th>Timestamp</th>
                                    <th>Transactions</th>
                                    <th>Nonce</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/blockchain-3d.js') }}"></script>
<script>
    let blockchainScene, blockchainRenderer, blockchainCamera, blockchainControls;
    let blocks = [];
    let blockMeshes = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        initBlockchainExplorer();
        loadBlockchainData();
    });
    
    function initBlockchainExplorer() {
        const container = document.getElementById('blockchain-3d');
        
        // Scene setup
        blockchainScene = new THREE.Scene();
        blockchainScene.background = new THREE.Color(0x0a0a0a);
        
        // Camera
        blockchainCamera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
        blockchainCamera.position.set(0, 5, 10);
        
        // Renderer
        blockchainRenderer = new THREE.WebGLRenderer({ antialias: true });
        blockchainRenderer.setSize(container.offsetWidth, container.offsetHeight);
        blockchainRenderer.shadowMap.enabled = true;
        blockchainRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(blockchainRenderer.domElement);
        
        // Orbit controls
        blockchainControls = new THREE.OrbitControls(blockchainCamera, blockchainRenderer.domElement);
        blockchainControls.enableDamping = true;
        blockchainControls.dampingFactor = 0.05;
        
        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
        blockchainScene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        blockchainScene.add(directionalLight);
        
        // Raycaster for click detection
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        blockchainRenderer.domElement.addEventListener('click', function(event) {
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            raycaster.setFromCamera(mouse, blockchainCamera);
            const intersects = raycaster.intersectObjects(blockMeshes);
            
            if (intersects.length > 0) {
                const clickedBlock = intersects[0].object;
                const blockData = clickedBlock.userData;
                showBlockDetails(blockData);
                
                // Highlight selected block
                blockMeshes.forEach(mesh => {
                    mesh.material.emissive.setHex(0x000000);
                });
                clickedBlock.material.emissive.setHex(0x333333);
            }
        });
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            blockchainControls.update();
            blockchainRenderer.render(blockchainScene, blockchainCamera);
        }
        animate();
        
        // Handle resize
        window.addEventListener('resize', function() {
            blockchainCamera.aspect = container.offsetWidth / container.offsetHeight;
            blockchainCamera.updateProjectionMatrix();
            blockchainRenderer.setSize(container.offsetWidth, container.offsetHeight);
        });
    }
    
    function loadBlockchainData() {
        fetch('/api/blocks')
            .then(response => response.json())
            .then(data => {
                blocks = data;
                updateBlockchainVisualization();
                updateBlocksTable();
                updateStats();
            })
            .catch(error => {
                console.error('Error loading blockchain data:', error);
            });
    }
    
    function updateBlockchainVisualization() {
        // Clear existing blocks
        blockMeshes.forEach(mesh => {
            blockchainScene.remove(mesh);
        });
        blockMeshes = [];
        
        const blockGeometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
        
        blocks.forEach((block, index) => {
            // Create block material based on type
            const isGenesis = block.index === 0;
            const blockMaterial = new THREE.MeshLambertMaterial({
                color: isGenesis ? 0x32CD32 : 0x1E90FF,
                transparent: true,
                opacity: 0.8
            });
            
            const blockMesh = new THREE.Mesh(blockGeometry, blockMaterial);
            blockMesh.position.x = index * 3;
            blockMesh.position.y = Math.sin(index * 0.5) * 0.5;
            blockMesh.castShadow = true;
            blockMesh.receiveShadow = true;
            
            // Store block data
            blockMesh.userData = block;
            
            blockchainScene.add(blockMesh);
            blockMeshes.push(blockMesh);
            
            // Add connecting lines
            if (index > 0) {
                const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                    new THREE.Vector3((index - 1) * 3, Math.sin((index - 1) * 0.5) * 0.5, 0),
                    new THREE.Vector3(index * 3, Math.sin(index * 0.5) * 0.5, 0)
                ]);
                const lineMaterial = new THREE.LineBasicMaterial({ color: 0x888888 });
                const line = new THREE.Line(lineGeometry, lineMaterial);
                blockchainScene.add(line);
            }
            
            // Add block index text
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 64;
            context.fillStyle = '#ffffff';
            context.font = '24px Arial';
            context.textAlign = 'center';
            context.fillText(`Block ${block.index}`, 64, 40);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.position.set(index * 3, Math.sin(index * 0.5) * 0.5 + 1.5, 0);
            sprite.scale.set(2, 1, 1);
            blockchainScene.add(sprite);
        });
        
        // Center camera on the chain
        if (blocks.length > 0) {
            const chainLength = (blocks.length - 1) * 3;
            blockchainCamera.position.set(chainLength / 2, 5, 10);
            blockchainControls.target.set(chainLength / 2, 0, 0);
        }
    }
    
    function updateBlocksTable() {
        const tbody = document.querySelector('#blocks-table tbody');
        tbody.innerHTML = '';
        
        blocks.forEach(block => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><span class="badge bg-primary">${block.index}</span></td>
                <td><code class="hash-short">${block.hash.substring(0, 16)}...</code></td>
                <td><code class="hash-short">${block.previous_hash.substring(0, 16)}...</code></td>
                <td>${new Date(block.timestamp).toLocaleString()}</td>
                <td><span class="badge bg-info">${block.transactions.length}</span></td>
                <td>${block.nonce}</td>
            `;
            
            row.addEventListener('click', () => showBlockDetails(block));
            row.style.cursor = 'pointer';
        });
    }
    
    function updateStats() {
        document.getElementById('total-blocks').textContent = blocks.length;
        document.getElementById('chain-length').textContent = blocks.length;
        
        let totalTransactions = 0;
        blocks.forEach(block => {
            totalTransactions += block.transactions.length;
        });
        document.getElementById('total-transactions').textContent = totalTransactions;
    }
    
    function showBlockDetails(block) {
        const infoPanel = document.getElementById('block-info');
        infoPanel.innerHTML = `
            <h6>Block #${block.index}</h6>
            <div class="block-detail-item">
                <strong>Hash:</strong>
                <code class="d-block">${block.hash}</code>
            </div>
            <div class="block-detail-item">
                <strong>Previous Hash:</strong>
                <code class="d-block">${block.previous_hash}</code>
            </div>
            <div class="block-detail-item">
                <strong>Timestamp:</strong>
                <span>${new Date(block.timestamp).toLocaleString()}</span>
            </div>
            <div class="block-detail-item">
                <strong>Nonce:</strong>
                <span>${block.nonce}</span>
            </div>
            <div class="block-detail-item">
                <strong>Transactions (${block.transactions.length}):</strong>
                <div class="transactions-list">
                    ${block.transactions.map(tx => `
                        <div class="transaction-item">
                            <small><strong>Type:</strong> ${tx.type}</small>
                            ${tx.user_id ? `<small><strong>User:</strong> ${tx.username || tx.user_id}</small>` : ''}
                            ${tx.amount ? `<small><strong>Amount:</strong> ${tx.amount}</small>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    function resetCamera() {
        const chainLength = (blocks.length - 1) * 3;
        blockchainCamera.position.set(chainLength / 2, 5, 10);
        blockchainControls.target.set(chainLength / 2, 0, 0);
        blockchainControls.update();
    }
    
    function animateChain() {
        blockMeshes.forEach((mesh, index) => {
            setTimeout(() => {
                mesh.material.emissive.setHex(0x444444);
                setTimeout(() => {
                    mesh.material.emissive.setHex(0x000000);
                }, 500);
            }, index * 200);
        });
    }
    
    function refreshBlockchain() {
        loadBlockchainData();
    }
</script>
{% endblock %}
